<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hosp_name }} Details (OSM)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <div class="row">
            <div class="col">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mb-4">‚Üê Back to Dashboard</a>
                <h2 class="text-primary mb-0">{{ hosp_name }}</h2>
                <h4 class="text-success" id="route-distance-text">{{ distance_km }} km away (Straight Line)</h4>
                <p class="text-muted">Route powered by OpenStreetMap Data</p>
            </div>
        </div>

        <div id="route-details" class="card shadow-sm p-3 mb-4">
            <p>Fetching optimal driving route and distance...</p>
        </div>

        <div id="map"></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data passed from Flask backend
        const userLat = parseFloat('{{ user_lat }}');
        const userLon = parseFloat('{{ user_lon }}');
        const hospLat = parseFloat('{{ hosp_lat }}');
        const hospLon = parseFloat('{{ hosp_lon }}');
        const hospitalName = decodeURIComponent('{{ hosp_name }}');
        
        let map;

        function initMap() {
            // Initialize map
            map = L.map('map').setView([userLat, userLon], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add Markers
            L.marker([userLat, userLon]).addTo(map)
                .bindPopup("<b>Your Location</b>").openPopup();

            L.marker([hospLat, hospLon]).addTo(map)
                .bindPopup("<b>" + hospitalName + "</b>").openPopup();

            // Fit map bounds to include both points
            const bounds = L.latLngBounds([userLat, userLon], [hospLat, hospLon]);
            map.fitBounds(bounds, { padding: [50, 50] });

            // Calculate and display route
            calculateAndDisplayRoute();
        }

        function calculateAndDisplayRoute() {
            const osrmUrl = `http://router.project-osrm.org/route/v1/driving/${userLon},${userLat};${hospLon},${hospLat}?overview=full&geometries=geojson`;
            
            document.getElementById('route-details').innerHTML = '<p>Searching for driving route...</p>';

            fetch(osrmUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'Ok' && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoords = route.geometry.coordinates;
                        
                        // Convert [lon, lat] pairs from OSRM to [lat, lon] for Leaflet
                        const latLngs = routeCoords.map(coord => [coord[1], coord[0]]);

                        // Draw the polyline route on the map
                        L.polyline(latLngs, { color: 'blue', weight: 5, opacity: 0.7 }).addTo(map);

                        // Update distance display
                        const distanceMeters = route.distance;
                        const distanceKm = (distanceMeters / 1000).toFixed(2);
                        const durationSeconds = route.duration;
                        const durationMinutes = Math.round(durationSeconds / 60);

                        document.getElementById('route-distance-text').innerHTML = `${distanceKm} km away (Driving)`;
                        document.getElementById('route-details').innerHTML = `
                            <p><strong>Total Driving Distance:</strong> ${distanceKm} km</p>
                            <p><strong>Estimated Travel Time:</strong> ${durationMinutes} minutes</p>
                            <p class="small text-muted">Note: Route is approximate and provided by OSRM demo server.</p>
                        `;

                        // Re-fit map bounds to the drawn route
                        map.fitBounds(L.polyline(latLngs).getBounds());

                    } else {
                        document.getElementById('route-details').innerHTML = '<p class="text-danger">Could not find a driving route via OSRM. Showing straight-line distance only.</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('route-details').innerHTML = '<p class="text-danger">Failed to fetch routing data due to network error.</p>';
                    console.error('OSRM Fetch error:', error);
                });
        }
        
        // Initialize map when page loads
        initMap();
    </script>
</body>
</html>